@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(user_customer, "Покупатель")
Person(user_accountant, "Бухгалтер")
Person(user_programmer, "Программист")

System(system_shop, "SaaS магазин", "Позволяет покупателю покупать товары и изменять тарифы")

System_Ext(system_email, "Почтовый сервис", "n8n - отправка писем клиенту через n8n на электронную почту")
System_Ext(system_bank, "Платежный шлюз", "Sber - страница оплаты продукта")
System_Ext(system_docs, "Сервис ЭДО", "Диадок - сервис подписания электронных документов")
System_Ext(system_ops, "OPS сервис", "Сервис приложений магазина")
System_Ext(system_site, "Сайт визитка", "Сайт с продуктами и их тарифами")

System_Boundary(system_shop, "SaaS магазин") {
    ContainerQueue(system_queue, "Брокер сообщений", "RabbitMQ")
    Container(system_flow, "Автоматизация", "n8n")

    Container(system_admin, "Сервис продуктов", "NodeJs + Strapi CMS")
    Container(system_sign, "Сервис клиентов", ".Net Core + Keycloak")
    Container(system_billing, "Сервис заказов + биллинг", ".Net Core")
    
    Container(system_account_front, "Личный кабинет фронтенд", "VueJs + Vuetify")
}

' Все сервисы могут отправлять в брокер почтовые сообщения клиенту
' Админка может читать данные из любых сервисов

Rel(user_accountant, system_admin, "Ручное изменение статуса оплаты")
Rel(user_programmer, system_admin, "Настраивает продукты")
Rel(system_admin, system_queue, "Изменение статуса оплаты (из админки)")
' Rel(system_admin, system_site, "Получение продуктов")

Rel(system_queue, system_billing, "Изменение статуса оплаты (из админки)")
Rel(system_billing, system_ops, "Запуск/остановка приложения; Изменение кол-ва лицензий")

Rel(system_account_front, system_billing, "Создание заказа; Изменение кол-ва лицензий")
Rel(user_customer, system_account_front, "Просмотр продуктов; Покупка продуктов; Изменение тарифа")
Rel(user_customer, system_site, "Просмотр продуктов")
Rel(system_account_front, system_sign, "Вход/регистрация")
Rel(system_sign, system_account_front, "Возврат JWT")

Rel(system_account_front, system_bank, "Переход на страницу оплаты продукта")
Rel(system_bank, system_billing, "Отправка статуса оплаты")

Rel(system_queue, system_flow, "Отправка писем покупателю")
Rel(system_flow, system_email, "Отправка писем покупателю")

Rel(system_account_front, system_docs, "Переход на подписание документов")
Rel(system_billing, system_docs, "Создание акта")
Rel(system_ops, system_billing, "Статус OPS операции")

@enduml